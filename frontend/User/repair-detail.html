<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>ใบแจ้งซ่อมอุปกรณ์</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f4f7f6; }
        .ticket-container { max-width: 800px; margin: 30px auto; background: white; padding: 40px; border-radius: 10px; shadow: 0 0 10px rgba(0,0,0,0.1); }
        .header-title { border-bottom: 3px solid #007bff; padding-bottom: 10px; margin-bottom: 20px; }
        .info-label { font-weight: bold; color: #555; width: 150px; display: inline-block; }
        .problem-box { background: #fff3f3; border-left: 5px solid #d9534f; padding: 15px; margin-top: 20px; }
        .img-evidence { width: 200px; height: 200px; object-fit: cover; border-radius: 5px; margin: 5px; }
        @media print {
            .no-print { display: none; }
            body { background: white; }
            .ticket-container { shadow: none; margin: 0; width: 100%; }
        }
    </style>
</head>
<body>

<div class="container no-print mt-3 text-end">
    <button onclick="window.history.back()" class="btn btn-secondary">กลับ</button>
    <button onclick="window.print()" class="btn btn-success">สั่งพิมพ์ใบแจ้งซ่อม</button>
</div>

<div class="ticket-container shadow">
    <div class="header-title d-flex justify-content-between align-items-center">
        <h2><i class="fas fa-tools"></i> ใบรายละเอียดการแจ้งซ่อม</h2>
        <h4 id="repair-id-text" class="text-muted">#</h4>
    </div>

    <div class="row mt-4">
        <div class="col-md-6">
            <p><span class="info-label">ยี่ห้อ/รุ่น:</span> <span id="brand">-</span></p>
            <p><span class="info-label">เลขทรัพย์สิน:</span> <span id="asset_number">-</span></p>
            <p><span class="info-label">Serial Number:</span> <span id="serial_number">-</span></p>
        </div>
        <div class="col-md-6 text-end">
            <p><span class="info-label">วันที่แจ้ง:</span> <span id="created_at">-</span></p>
            <p><span class="info-label">สถานะ:</span> <span id="status" class="badge bg-danger">-</span></p>
        </div>
    </div>

    <hr>

    <div class="row">
        <div class="col-12">
            <h5>ข้อมูลผู้แจ้งซ่อม</h5>
            <p><span class="info-label">ชื่อพนักงาน:</span> <span id="employee_name">-</span></p>
            <p><span class="info-label">แผนก/ฝ่าย:</span> <span id="affiliation">-</span></p>
            <p><span class="info-label">เบอร์โทรศัพท์:</span> <span id="phone_number">-</span></p>
        </div>
    </div>

    <div class="problem-box">
        <h5><i class="fas fa-exclamation-circle"></i> อาการที่พบ/ปัญหา:</h5>
        <p id="problem" class="mb-0">กำลังโหลดข้อมูล...</p>
    </div>

    <div class="mt-4">
        <h5>รูปภาพประกอบ:</h5>
        <div id="image-gallery" class="d-flex flex-wrap"></div>
    </div>

    <div class="mt-5 pt-5 row">
        <div class="col-6 text-center">
            <p>__________________________</p>
            <p>( ผู้แจ้งซ่อม )</p>
        </div>
        <div class="col-6 text-center">
            <p>__________________________</p>
            <p>( เจ้าหน้าที่ไอที/ผู้รับซ่อม )</p>
        </div>
    </div>
</div>

<script>
    
    const CONFIG = { API_BASE: `http://${window.location.hostname}:5000` };
    
    async function loadDetail() {
        const urlParams = new URLSearchParams(window.location.search);
        const itemId = urlParams.get('id');

        if (!itemId) return alert('ไม่พบรหัสอุปกรณ์');

        try {
            // ดึงข้อมูลจาก API ตัวเดิมของคุณ
            const response = await fetch(`${CONFIG.API_BASE}/api/repair?limit=999`);
            const result = await response.json();

            if (result.success) {
                // ค้นหาข้อมูลที่ item_id ตรงกัน
                const repair = result.data.find(r => r.item_id == itemId);

                if (!repair) {
                    document.getElementById('problem').innerText = 'ไม่พบข้อมูลการซ่อมสำหรับอุปกรณ์นี้';
                    return;
                }

                // นำข้อมูลไปใส่ในหน้า HTML
                document.getElementById('repair-id-text').innerText = `ID: ${repair.repair_id}`;
                document.getElementById('brand').innerText = repair.brand;
                document.getElementById('asset_number').innerText = repair.asset_number || '-';
                document.getElementById('serial_number').innerText = repair.serial_number || '-';
                document.getElementById('created_at').innerText = new Date(repair.created_at).toLocaleString('th-TH');
                document.getElementById('employee_name').innerText = repair.employee_name || '-';
                document.getElementById('affiliation').innerText = repair.affiliation || '-';
                document.getElementById('phone_number').innerText = repair.phone_number || '-';
                document.getElementById('problem').innerText = repair.problem;
                
                // แสดงรูปภาพ
                const gallery = document.getElementById('image-gallery');
                if (repair.file_paths && repair.file_paths.length > 0) {
                    repair.file_paths.forEach(path => {
                        if(path) {
                            const img = document.createElement('img');
                            img.src = `${CONFIG.API_BASE}/uploads/repairs/${path}`;
                            img.className = 'img-evidence border shadow-sm';
                            gallery.appendChild(img);
                        }
                    });
                } else {
                    gallery.innerHTML = '<p class="text-muted">ไม่มีรูปภาพประกอบ</p>';
                }
            }
        } catch (err) {
            console.error(err);
            alert('เกิดข้อผิดพลาดในการโหลดข้อมูล');
        }
    }

    document.addEventListener('DOMContentLoaded', loadDetail);
</script>

</body>
</html>