<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ã‡πà‡∏≠‡∏° - ‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏∑‡∏°‡∏Ñ‡∏∑‡∏ô</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <style>
    body {
        background: linear-gradient(135deg, #dadce6 0%, #e01010 100%);
        min-height: 100vh;
        padding: 20px 0;
        font-family: 'Sarabun', sans-serif;
    }
    .container-custom {
        background: white;
        border-radius: 10px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        padding: 30px;
        margin: auto;
        max-width: 95%;
    }
    .header {
        margin-bottom: 30px;
        border-bottom: 2px solid #667eea;
        padding-bottom: 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .stat-card {
        background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%); /* ‡∏™‡∏µ‡πÅ‡∏î‡∏á/‡∏™‡πâ‡∏° ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏° */
        color: white;
        padding: 20px;
        border-radius: 8px;
        text-align: center;
        margin-bottom: 20px;
    }
</style>
</head>
<body>

<div class="container-custom">
    <div class="header">
        <h1 class="h3"><i class="fas fa-tools me-2"></i> ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏≥‡πÑ‡∏õ‡∏ã‡πà‡∏≠‡∏°</h1>
        <a href="index.html" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-1"></i> ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
        </a>
    </div>

    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stat-card">
                <i class="fas fa-hammer mb-2 fa-2x"></i>
                <div class="h2 font-weight-bold" id="repair-count">0</div>
                <div class="small">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡πà‡∏≠‡∏°</div>
            </div>
        </div>
        <div class="col-md-9">
             <input type="text" id="search-input" class="form-control form-control-lg mb-3" 
                    placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡πà‡∏≠‡∏°..." oninput="searchRepairItems()">
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-hover" id="repairTable">
            <thead style="background-color: #667eea; color: white;">
                <tr>
                    <th>‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                    <th>‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</th>
                    <th>‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</th>
                    <th>Asset Number</th>
                    <th>Serial Number</th>
                    <th class="text-center">‡∏•‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
                </tr>
            </thead>
            <tbody id="repair-list">
                </tbody>
        </table>
    </div>
</div>

<div style="display: none;">
    <span id="usernameDisplay"></span>
    <h2 id="total-items">0</h2>
    <input type="text" id="inventory-search">
    <div id="inventory-list"></div>
    <div id="pagination-container"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="admin-script.js"></script>

<script>
const CONFIG = { API_BASE: `http://${window.location.hostname}:5000` };

// 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏™‡∏£‡πâ‡∏≤‡∏á Badge ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (‡πÅ‡∏Å‡πâ Error: getStatusBadge is not defined)
function getStatusBadge(status) {
    switch (status) {
        case 'Pending': return '<span class="badge bg-secondary">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</span>';
        case 'In Progress': return '<span class="badge bg-primary">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡πà‡∏≠‡∏°</span>';
        case 'Fixed': return '<span class="badge bg-success">‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</span>';
        case 'Repair': return '<span class="badge bg-danger">‡∏™‡πà‡∏á‡∏ã‡πà‡∏≠‡∏°</span>';
        default: return `<span class="badge bg-info">${status}</span>`;
    }
}

// 2. ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Repair/Maintenance
async function loadRepairItems() {
    try {
        const response = await fetch(`${CONFIG.API_BASE}/items?page=1&limit=999`); 
        const data = await response.json();
        
        const itemsInRepair = data.items.filter(item => 
            item.status === 'Repair' || item.status === 'Maintenance'
        );

        document.getElementById('repair-count').textContent = itemsInRepair.length;
        displayRepairTable(itemsInRepair);
    } catch (err) {
        console.error('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°‡πÑ‡∏î‡πâ:', err);
    }
}

// 3. ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
function displayRepairTable(items) {
    const tbody = document.getElementById('repair-list');
    tbody.innerHTML = '';

    items.forEach((item, index) => {
        const row = `
            <tr class="align-middle">
                <td>${index + 1}</td>
                <td><img src="${CONFIG.API_BASE}/uploads/${item.image_url}" width="50" height="50" style="object-fit: cover;" class="rounded border" onerror="this.src='https://via.placeholder.com/50'"></td>
                <td><strong>${item.item_name}</strong></td>
                <td><code class="text-dark">${item.asset_number || '-'}</code></td>
                <td><small>${item.serial_number || '-'}</small></td>
                <td class="text-center">
                    <button class="btn btn-sm btn-primary px-3" onclick="showRepairDetail(${item.item_id})">
                        <i class="fas fa-search-plus me-1"></i> ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°
                    </button>
                </td>
            </tr>`;
        tbody.innerHTML += row;
    });
}

// 4. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• "‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ã‡πà‡∏≠‡∏°" ‡∏°‡∏≤‡πÇ‡∏ä‡∏ß‡πå (‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å API /api/repair)
async function showRepairDetail(itemId) {
    try {
        Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...', didOpen: () => Swal.showLoading() });

        // 1. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πà‡∏≠‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÄ‡∏û‡∏¥‡πà‡∏° limit ‡πÉ‡∏´‡πâ‡πÄ‡∏¢‡∏≠‡∏∞‡πÜ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°)
        const response = await fetch(`${CONFIG.API_BASE}/api/repair?limit=999`);
        const result = await response.json();

        if (result.success) {
            // 2. ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ô Array ‡∏ß‡πà‡∏≤‡∏ï‡∏±‡∏ß‡πÑ‡∏´‡∏ô‡∏°‡∏µ item_id ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡∏Å‡∏î
            const repair = result.data.find(r => r.item_id == itemId);

            if (!repair) {
                return Swal.fire('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏ã‡πà‡∏≠‡∏°', 'info');
            }

            // 3. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡πÉ‡∏ä‡πâ file_paths ‡∏ó‡∏µ‡πà API split ‡∏°‡∏≤‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß)
            let imgHtml = '';
            if (repair.file_paths && repair.file_paths.length > 0) {
                imgHtml = '<div class="mt-3 d-flex flex-wrap gap-2 justify-content-center">';

            }

            // 4. ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
            Swal.fire({
                title: `<i class="fas fa-tools"></i> ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°`,
                html: `
                    <div class="text-start" style="font-size: 0.9rem;">
                        <p><b>‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå:</b> ${repair.brand}</p>
                        <p><b>‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á:</b> ${repair.employee_name}</p>
                        <p><b>‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô:</b> ${repair.employees_code}</p>
                        <p><b>‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î:</b> ${repair.affiliation}</p>
                        <p><b>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£:</b> ${repair.phone_number || '-'}</p>
                        <p><b>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°:</b> ${new Date(repair.created_at).toLocaleDateString('th-TH', {
                            year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit'
                        })}</p>
                        <p><b>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏™‡∏£‡πá‡∏à:</b> ${repair.updated_at ? new Date(repair.updated_at).toLocaleDateString('th-TH', {
                            year: 'numeric', month: 'long', day: 'numeric'
                        }) : '-'}</p>
                        <hr>
                        <div class="bg-light p-2 rounded">
                            <b class="text-danger">‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢:</b><br>${repair.problem || '-'}
                        </div>
                        ${imgHtml}
                    </div>
                `,
                confirmButtonText: '‡∏õ‡∏¥‡∏î'
            });
        }
    } catch (err) {
        console.error(err);
        Swal.fire('Error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ API ‡πÑ‡∏î‡πâ', 'error');
    }
}

function searchRepairItems() {
    const searchTerm = document.getElementById('search-input').value.toLowerCase();
    const rows = document.getElementById('repair-list').querySelectorAll('tr');
    rows.forEach(row => {
        row.style.display = row.innerText.toLowerCase().includes(searchTerm) ? '' : 'none';
    });
}

document.addEventListener('DOMContentLoaded', loadRepairItems);
</script>

</body>
</html>