<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Repair Tracking | Modern Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500&family=Sarabun:wght@400;600&display=swap"
        rel="stylesheet">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<script src="THSarabun-Bold.js"></script>

<script src="pdf-generator.js"></script>
    <style>       
        :root {
            --primary-color: #4361ee;
            --pending-color: #ff4d6d;
            --progress-color: #fb8500;
            --fixed-color: #06d6a0;
            --bg-color: #f8f9fc;
        }

        body {
            background-color: var(--bg-color);
            font-family: 'Kanit', 'Sarabun', sans-serif;
            padding: 30px 15px;
        }

        .container-custom {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.04);
            padding: 35px;
        }

        .header-title {
            color: #2b2d42;
            font-weight: 600;
            letter-spacing: -0.5px;
        }

        .table-responsive {
            border-radius: 16px;
            overflow: hidden;
            margin-top: 20px;
        }

        .table {
            border-collapse: separate;
            border-spacing: 0 8px;
            margin-bottom: 0;
        }

        .table thead th {
            background: transparent;
            border: none;
            color: #8d99ae;
            font-weight: 500;
            font-size: 0.85rem;
            padding: 15px;
        }

        .table tbody tr {
            background: white;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
        }

        .table tbody tr:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            background: #fff;
        }

        .table td {
            border: none;
            padding: 20px 15px;
            vertical-align: middle;
        }

        .table td:first-child {
            border-radius: 12px 0 0 12px;
        }

        .table td:last-child {
            border-radius: 0 12px 12px 0;
        }

        /* Status Badges */
        .status-pill {
            padding: 6px 16px;
            border-radius: 100px;
            font-size: 0.75rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .status-pill.status-fixed {
            background: #e6fcf5;
            color: #0c85d0;
            /* หรือสีเขียว #06d6a0 */
            border: 1px solid #06d6a0;
        }

        .status-pending {
            background: #fff1f2;
            color: var(--pending-color);
        }

        .status-progress {
            background: #fff8eb;
            color: var(--progress-color);
        }

        .status-fixed {
            background: #e6fcf5;
            color: var(--fixed-color);
        }

        /* Icon Buttons */
        .btn-action {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            border: none;
        }

        .btn-view {
            background: #edf2ff;
            color: var(--primary-color);
        }

        .btn-view:hover {
            background: var(--primary-color);
            color: white;
        }

        .btn-update {
            background: #f8f9fa;
            color: #333;
            font-size: 0.8rem;
            padding: 5px 15px;
            width: auto;
        }

        .btn-update:hover {
            background: #e9ecef;
        }

        code.sn-code {
            background: #f1f3f5;
            color: #495057;
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 0.8rem;
        }

        .contract-code {
            color: var(--primary-color);
            font-weight: 500;
            font-size: 0.85rem;
        }
    </style>
</head>

<body>
    <div class="container-fluid container-custom">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4 gap-3">
            <div>
                <h3 class="header-title mb-1"><i class="fas fa-microchip text-primary me-2"></i>ระบบบริหารงานซ่อม</h3>
                <p class="text-muted small mb-0">ติดตามและจัดการสถานะอุปกรณ์ส่งซ่อมแบบ Real-time</p>
            </div>
            
                <a href="index.html" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-1"></i> กลับหน้าหลัก
        </a>
            
        </div>

        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>ลำดับ</th>
                        <th>ข้อมูลผู้แจ้ง</th>
                        <th>อุปกรณ์ / รุ่น</th>
                        <th>รหัส S/N</th>
                        <th>เลขที่สัญญา</th>
                        <th>อาการเสีย</th>
                        <th>ขั้นตอนการซ่อม</th>
                        <th>วันที่แจ้ง</th>
                        <th>สถานะ</th>
                        <th>หลักฐาน</th>
                        <th class="text-center">จัดการ</th>
                    </tr>
                </thead>
                <tbody id="repair-table-body">
                </tbody>
            </table>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        const API_BASE = "http://192.168.1.159:5000";

        async function loadRepairData() {
            try {
                const res = await fetch(`${API_BASE}/api/repair-status`);
                const result = await res.json();
                if (result.success) displayRepairs(result.data);
            } catch (err) { console.error("Error:", err); }
        }

        function displayRepairs(repairs) {
    const body = document.getElementById('repair-table-body');
    body.innerHTML = '';

    repairs.forEach((repair, index) => {
        const date = new Date(repair.created_at).toLocaleDateString('th-TH', {
            day: 'numeric', month: 'short', year: '2-digit', hour: '2-digit', minute: '2-digit'
        });

        // 1. จัดการรูปภาพหลักฐานการแจ้งซ่อม (ที่มีอยู่เดิม)
        let fileHtml = '-';
        if (repair.repair_url) {
            const files = repair.repair_url.split(',');
            fileHtml = files.map(filename => {
                const cleanName = filename.trim();
                const fullUrl = `${API_BASE}/uploads/repairs/${cleanName}`;
                const isPDF = cleanName.toLowerCase().endsWith('.pdf');
                const icon = isPDF ? 'fas fa-file-pdf text-danger' : 'fas fa-image text-primary';
                return `<a href="${fullUrl}" target="_blank" class="btn-action btn-view me-1" title="ดูหลักฐานแจ้งซ่อม">
                            <i class="${icon}"></i>
                        </a>`;
            }).join('');
        }

        // 2. กำหนดสีและข้อความตามสถานะ
        let statusClass = '';
        let statusText = '';
        
        if (repair.status === 'Pending') {
            statusClass = 'status-pending';
            statusText = '<i class="fas fa-clock"></i> รอรับเรื่อง';
        } else if (repair.status === 'In Progress') {
            statusClass = 'status-progress';
            statusText = '<i class="fas fa-tools"></i> กำลังซ่อม';
        } else {
            statusClass = 'status-fixed';
            statusText = '<i class="fas fa-check-circle"></i> เสร็จสิ้น';
        }

        // 3. จัดการปุ่มในคอลัมน์ "จัดการ"
        let actionButtons = '';
        if (repair.status === 'Pending') {
            actionButtons = `<button class="btn btn-update shadow-sm" onclick="updateStatus(${repair.repair_id}, 'In Progress')">รับงาน</button>`;
        } else if (repair.status === 'In Progress') {
            // ส่งข้อมูล repair เข้าไปเพื่อใช้ในขั้นตอน Gen PDF
            actionButtons = `<button class="btn btn-update shadow-sm text-success" onclick='finishRepair(${repair.repair_id}, ${repair.item_id}, ${JSON.stringify(repair)})'>ปิดงาน</button>`;
        } else if (repair.status === 'Fixed') {
            // ถ้าซ่อมเสร็จแล้ว และมีชื่อไฟล์รายงานใน report_url ให้แสดงปุ่มเปิด PDF
            actionButtons = `
                <div class="d-flex flex-column align-items-center gap-1">
                    <span class="badge bg-light text-success mb-1">สำเร็จแล้ว</span>
                    ${repair.report_url ? 
                        `<a href="${API_BASE}/uploads/reports/${repair.report_url}" target="_blank" class="btn btn-sm btn-outline-danger shadow-sm">
                            <i class="fas fa-file-pdf"></i> ดูรายงาน PDF
                         </a>` : 
                        `<small class="text-muted">ไม่มีไฟล์รายงาน</small>`
                    }
                </div>`;
        }

        body.innerHTML += `
            <tr>
                <td><span class="text-muted fw-bold">${index + 1}</span></td>
                <td>
                    <div class="fw-bold">${repair.employee_name || 'ไม่ระบุ'}</div>
                    <div class="text-muted small">${repair.department || '-'}</div>
                </td>
                <td><div class="fw-medium text-dark">${repair.brand || '-'}</div></td>
                <td><code class="sn-code">${repair.serial_number || '-'}</code></td>
                <td><span class="contract-code">${repair.contract_number || '-'}</span></td>
                <td><div class="text-truncate" style="max-width: 150px;" title="${repair.problem}">${repair.problem}</div></td>
                <td><div class="text-truncate" style="max-width: 150px;" title="${repair.Procedure || '-'}">${repair.Procedure || '-'}</div></td>
                <td><small class="text-muted">${date}</small></td>
                <td><span class="status-pill ${statusClass}">${statusText}</span></td>
                <td>${fileHtml}</td>
                <td class="text-center">${actionButtons}</td>
            </tr>
        `;
    });
}

        // Logic functions (updateStatus, finishRepair) remains same as previous version but linked here
        async function updateStatus(repairId, status) {
            const res = await fetch(`${API_BASE}/api/repair/status/${repairId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status })
            });
            if (res.ok) loadRepairData();
        }

        // แก้ไขฟังก์ชัน finishRepair ใหม่ทั้งหมด
async function finishRepair(repairId, itemId, repairData) {
    // 1. แสดง Popup ให้กรอกรายละเอียดการซ่อม (Procedure)
    const { value: repairProcedure } = await Swal.fire({
        title: 'ระบุรายละเอียดการซ่อม',
        input: 'textarea',
        inputLabel: 'ขั้นตอนการดำเนินงาน / วิธีแก้ไข',
        inputPlaceholder: 'เช่น เปลี่ยนบอร์ดใหม่, ลงโปรแกรมใหม่...',
        showCancelButton: true,
        confirmButtonText: 'บันทึกและสร้าง PDF',
        cancelButtonText: 'ยกเลิก',
        confirmButtonColor: '#06d6a0',
        preConfirm: (value) => {
            if (!value) {
                Swal.showValidationMessage('กรุณากรอกขั้นตอนการซ่อมก่อนปิดงาน');
            }
            return value;
        }
    });

    // 2. ถ้าผู้ใช้กดยืนยัน (ได้ค่า Procedure มา)
    if (repairProcedure) {
        // นำข้อมูลเดิมมารวมกับขั้นตอนการซ่อมที่เพิ่งกรอก
        const finalData = { 
            ...repairData, 
            Procedure: repairProcedure,
            repair_id: repairId, // มั่นใจว่ามี ID
            item_id: itemId     // มั่นใจว่ามี item_id เพื่อปลดล็อกสถานะอุปกรณ์
        };

        // 3. เรียกฟังก์ชันจากไฟล์ pdf-generator.js 
        // ฟังก์ชันนี้จะทำหน้าที่: 
        // - ถามเลขที่อนุมัติ/วันที่/วงเงิน 
        // - Gen PDF 
        // - Upload ไฟล์ 
        // - Update Status เป็น 'Fixed' พร้อมชื่อไฟล์ PDF ใน DB
        if (typeof handleFinishAndGeneratePDF === 'function') {
            handleFinishAndGeneratePDF(finalData);
        } else {
            console.error("หาฟังก์ชัน handleFinishAndGeneratePDF ไม่เจอ ตรวจสอบการโหลดไฟล์ pdf-generator.js");
            Swal.fire('Error', 'ไม่สามารถเรียกใช้ระบบสร้าง PDF ได้', 'error');
        }
    }
}

        document.addEventListener('DOMContentLoaded', loadRepairData);
    </script>
</body>

</html>