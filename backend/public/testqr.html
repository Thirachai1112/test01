<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <title>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* üé® ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            padding: 15px; 
            line-height: 1.6; 
            background-color: #f0f2f5; 
            color: #333;
        }

        /* üì± Card ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ */
        .card { 
            border: none; 
            padding: 20px; 
            border-radius: 15px; 
            width: 100%;
            max-width: 500px; 
            background: white; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
            margin: 10px auto; 
        }

        .back-link { margin-bottom: 20px; }
        .back-link a { 
            text-decoration: none; 
            color: #555; 
            font-size: 14px; 
            display: inline-flex; 
            align-items: center; 
        }

        h2 { color: #1a73e8; margin-bottom: 15px; font-size: 1.5rem; text-align: center; }

        .info-row { 
            display: flex; 
            justify-content: space-between; 
            padding: 8px 0; 
            border-bottom: 1px solid #eee; 
            font-size: 14px;
        }
        .info-label { font-weight: bold; color: #666; }

        img { 
            width: 100%; 
            max-height: 300px; 
            object-fit: contain; 
            margin: 20px 0; 
            border-radius: 10px; 
            background: #fafafa;
        }

        .status-badge { 
            padding: 4px 12px; 
            border-radius: 20px; 
            font-size: 12px; 
            font-weight: bold;
            color: white;
        }

        /* üîò ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏°‡πÅ‡∏ö‡∏ö‡πÄ‡∏ï‡πá‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ ‡∏Å‡∏î‡∏á‡πà‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡∏¥‡πâ‡∏ß‡πÇ‡∏õ‡πâ‡∏á */
        .btn-borrow {
            background: linear-gradient(135deg, #28a745 0%, #218838 100%);
            color: white;
            border: none;
            padding: 16px;
            border-radius: 12px;
            cursor: pointer;
            width: 100%;
            font-size: 18px;
            margin-top: 25px;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(40, 167, 69, 0.3);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }
        .btn-borrow:disabled { background: #ccc; box-shadow: none; }

        /* ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á SweetAlert ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
        .swal2-input, .swal2-textarea { font-size: 16px !important; } /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô iOS ‡∏ã‡∏π‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å */
    </style>
</head>
<body>
    <div class="card">
        <div id="content">
            <p style="text-align:center;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå...</p>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const itemId = urlParams.get('id');
        const SERVER_IP = window.location.hostname;

        if (itemId) {
            fetch(`http://${SERVER_IP}:5000/items/${itemId}`)
                .then(response => response.json())
                .then(data => {
                    const item = data.items ? data.items[0] : data;
                    const isAvailable = item.status === 'Available';

                    document.getElementById('content').innerHTML = `
                        <h2>${item.item_name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠'}</h2>
                        
                        <div class="info-row">
                            <span class="info-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</span>
                            <span class="status-badge" style="background:${isAvailable ? '#28a745' : '#dc3545'}">${item.status}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">‡πÄ‡∏•‡∏Ç‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô</span>
                            <span>${item.asset_number || '-'}</span>
                        </div>
                         <div class="info-row">
                            <span class="info-label">‡∏™‡∏±‡∏ç‡∏ç‡∏≤</span>
                            <span>${item.asset_number || '-'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Serial Number</span>
                            <span>${item.serial_number || '-'}</span>
                        </div>

                        ${item.image_url 
                            ? `<img src="http://${SERVER_IP}:5000/uploads/${item.image_url}" alt="‡∏£‡∏π‡∏õ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå" onerror="this.src='https://via.placeholder.com/400x300?text=‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û'">` 
                            : '<div style="height:100px; display:flex; align-items:center; justify-content:center; color:#ccc;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö</div>'}
                        
                        <button class="btn-borrow" onclick="borrowItem('${item.item_id}')" ${!isAvailable ? 'disabled' : ''}>
                            <i class="fas fa-hand-pointer"></i> 
                            ${isAvailable ? '‡∏¢‡∏∑‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ä‡∏¥‡πâ‡∏ô‡∏ô‡∏µ‡πâ' : '‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ñ‡∏π‡∏Å‡∏¢‡∏∑‡∏°‡∏≠‡∏¢‡∏π‡πà'}
                        </button>
                    `;
                })
                .catch(err => {
                    document.getElementById('content').innerHTML = `<p class="error">‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${err.message}</p>`;
                });
        }

        function borrowItem(id) {
            Swal.fire({
                title: '‡∏£‡∏∞‡∏ö‡∏∏‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡∏°‡πÅ‡∏•‡∏∞‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô',
                html: `
                    <div style="text-align: left;">
                        <label class="swal2-label">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</label>
                        <input id="swal-input1" class="swal2-input" placeholder="‡∏ä‡∏∑‡πà‡∏≠ (First Name)">
                        <input id="swal-input2" class="swal2-input" placeholder="‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• (Last Name)">
                        <input id="swal-input3" class="swal2-input" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô">
                        <input id="swal-input4" class="swal2-input" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå">
                        <input id="swal-input5" class="swal2-input" placeholder="‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î/‡πÅ‡∏ú‡∏ô‡∏Å">
                        <textarea id="swal-input6" class="swal2-textarea" placeholder="‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°"></textarea>
                        
                        <label class="swal2-label" style="display: block; margin-top: 15px;">‡πÅ‡∏ô‡∏ö‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô (‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏™‡∏†‡∏≤‡∏û‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á/‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£)</label>
                        <input type="file" id="swal-input-file" class="swal2-file" multiple accept="image/*,.pdf" style="display: block; width: 100%; margin-top: 5px;">
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                focusConfirm: false,
                preConfirm: () => {
                    const firstName = document.getElementById('swal-input1').value;
                    const empCode = document.getElementById('swal-input3').value;
                    
                    if (!firstName || !empCode) {
                        Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô');
                        return false;
                    }

                    return {
                        firstName: firstName,
                        lastName: document.getElementById('swal-input2').value,
                        empCode: empCode,
                        phone: document.getElementById('swal-input4').value,
                        dept: document.getElementById('swal-input5').value,
                        purpose: document.getElementById('swal-input6').value,
                        files: document.getElementById('swal-input-file').files
                    }
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    // ‡πÉ‡∏ä‡πâ FormData ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå
                    const formData = new FormData();
                    formData.append('item_id', id);
                    formData.append('first_name', result.value.firstName);
                    formData.append('last_name', result.value.lastName);
                    formData.append('employees_code', result.value.empCode);
                    formData.append('phone_number', result.value.phone);
                    formData.append('affiliation', result.value.dept);
                    formData.append('purpose', result.value.purpose);
                    
                    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô FormData (‡∏ä‡∏∑‡πà‡∏≠ 'files' ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö Backend)
                    if (result.value.files.length > 0) {
                        for (let i = 0; i < result.value.files.length; i++) {
                            formData.append('files', result.value.files[i]);
                        }
                    }

                    // ‡πÅ‡∏™‡∏î‡∏á Loading ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏™‡πà‡∏á
                    Swal.fire({
                        title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...',
                        allowOutsideClick: false,
                        didOpen: () => { Swal.showLoading(); }
                    });

                    fetch(`http://${SERVER_IP}:5000/borrow`, {
                        method: 'POST',
                        body: formData // ‡∏™‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô formData ‡πÅ‡∏ó‡∏ô JSON
                    })
                    .then(res => res.json())
                    .then(data => {
                        if (data.message && !data.error) {
                            Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success')
                                .then(() => location.reload());
                        } else {
                            Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', data.error || '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', 'error');
                        }
                    })
                    .catch(err => {
                        Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ', 'error');
                    });
                }
            });
        }
    </script>
</body>
</html>