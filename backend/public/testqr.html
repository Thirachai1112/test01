<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy"
        content="default-src 'self' http://${SERVER_IP}:5000; img-src 'self' data: http://*:*; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; font-src 'self' https://cdnjs.cloudflare.com https://fonts.gstatic.com;">
    <title>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* üé® ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 15px;
            line-height: 1.6;
            background-color: #f0f2f5;
            color: #333;
        }

        /* üì± Card ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ */
        .card {
            border: none;
            padding: 20px;
            border-radius: 15px;
            width: 100%;
            max-width: 500px;
            background: white;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin: 10px auto;
        }

        .back-link {
            margin-bottom: 20px;
        }

        .back-link a {
            text-decoration: none;
            color: #555;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
        }

        h2 {
            color: #1a73e8;
            margin-bottom: 15px;
            font-size: 1.5rem;
            text-align: center;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }

        .info-label {
            font-weight: bold;
            color: #666;
        }

        img {
            width: 100%;
            max-height: 300px;
            object-fit: contain;
            margin: 20px 0;
            border-radius: 10px;
            background: #fafafa;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            color: white;
        }

        /* üîò ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏°‡πÅ‡∏ö‡∏ö‡πÄ‡∏ï‡πá‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ ‡∏Å‡∏î‡∏á‡πà‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡∏¥‡πâ‡∏ß‡πÇ‡∏õ‡πâ‡∏á */
        .btn-borrow {
            background: linear-gradient(135deg, #28a745 0%, #218838 100%);
            color: white;
            border: none;
            padding: 16px;
            border-radius: 12px;
            cursor: pointer;
            width: 100%;
            font-size: 18px;
            margin-top: 25px;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(40, 167, 69, 0.3);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }

        .btn-borrow:disabled {
            background: #ccc;
            box-shadow: none;
        }

        /* ‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏∑‡∏ô */
        .btn-return {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            border: none;
            padding: 16px;
            border-radius: 12px;
            cursor: pointer;
            width: 100%;
            font-size: 18px;
            margin-top: 10px;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0, 123, 255, 0.3);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }

        .btn-return:disabled {
            background: #ccc;
            box-shadow: none;
        }

        /* ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á SweetAlert ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
        .swal2-input,
        .swal2-textarea {
            font-size: 16px !important;
        }

        /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô iOS ‡∏ã‡∏π‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å */
    </style>
</head>

<body>
    <div class="card">
        <div id="content">
            <p style="text-align:center;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå...</p>
        </div>
    </div>

    <script>
        let currentItemData = null;
        const urlParams = new URLSearchParams(window.location.search);
        const itemId = urlParams.get('id');
        const SERVER_IP = window.location.hostname;


        if (itemId) {
            fetch(`http://${SERVER_IP}:5000/items/${itemId}`)
                .then(response => response.json())
                .then(data => {
                    currentItemData = data.items ? data.items[0] : data;
                    const item = currentItemData;
                    const isAvailable = item.status === 'Available';

                    document.getElementById('content').innerHTML = `
                        <h2>${item.item_name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠'}</h2>
                        
                        <div class="info-row">
                            <span class="info-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</span>
                            <span class="status-badge" style="background:${isAvailable ? '#28a745' : '#dc3545'}">${item.status}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">‡πÄ‡∏•‡∏Ç‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô</span>
                            <span>${item.asset_number || '-'}</span>
                        </div>
                         <div class="info-row">
                            <span class="info-label">‡∏™‡∏±‡∏ç‡∏ç‡∏≤</span>
                            <span>${item.asset_number || '-'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Serial Number</span>
                            <span>${item.serial_number || '-'}</span>
                        </div>

                        ${item.image_url
                            ? `<img src="http://${SERVER_IP}:5000/uploads/${item.image_url}" alt="‡∏£‡∏π‡∏õ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå" onerror="this.src='https://via.placeholder.com/400x300?text=‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û'">`
                            : '<div style="height:100px; display:flex; align-items:center; justify-content:center; color:#ccc;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö</div>'}
                        
                        <button class="btn-borrow" onclick="borrowItem('${item.item_id}')" ${!isAvailable ? 'disabled' : ''}>
                            <i class="fas fa-hand-pointer"></i> 
                            ${isAvailable ? '‡∏¢‡∏∑‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ä‡∏¥‡πâ‡∏ô‡∏ô‡∏µ‡πâ' : '‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ñ‡∏π‡∏Å‡∏¢‡∏∑‡∏°‡∏≠‡∏¢‡∏π‡πà'}
                        </button>

                        <button class="btn-borrow" onclick="repairItem('${item.item_id}')" ${!isAvailable ? 'disabled' : ''}>
                            <i class="fas fa-hand-pointer"></i> 
                            ${isAvailable ? '‡∏ô‡∏≥‡πÑ‡∏õ‡∏ã‡πà‡∏≠‡∏°' : '‡∏ñ‡∏π‡∏Å‡∏ô‡∏≥‡πÑ‡∏õ‡∏ã‡πà‡∏≠‡∏°‡∏≠‡∏¢‡∏π‡πà'}
                        </button>

                        <button class="btn-return" onclick="returnItem('${item.item_id}')" ${isAvailable ? 'disabled' : ''}>
                            <i class="fas fa-undo"></i> 
                            ${!isAvailable ? '‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå' : '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ (‡∏ß‡πà‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà)'}
                        </button>
                    `;
                })
                .catch(err => {
                    document.getElementById('content').innerHTML = `<p class="error">‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${err.message}</p>`;
                });
        }

        function borrowItem(id) {
            Swal.fire({
                title: '‡∏£‡∏∞‡∏ö‡∏∏‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡∏°‡πÅ‡∏•‡∏∞‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô',
                html: `
                    <div style="text-align: left;">
                        <label class="swal2-label">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</label>
                        <input id="swal-input1" class="swal2-input" placeholder="‡∏ä‡∏∑‡πà‡∏≠ (First Name)">
                        <input id="swal-input2" class="swal2-input" placeholder="‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• (Last Name)">
                        <input id="swal-input3" class="swal2-input" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô">
                        <input id="swal-input4" class="swal2-input" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå">
                        <input id="swal-input5" class="swal2-input" placeholder="‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î/‡πÅ‡∏ú‡∏ô‡∏Å">
                        <textarea id="swal-input6" class="swal2-textarea" placeholder="‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°"></textarea>
                        
                        <label class="swal2-label" style="display: block; margin-top: 15px;">‡πÅ‡∏ô‡∏ö‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô (‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏™‡∏†‡∏≤‡∏û‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á/‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£)</label>
                        <input type="file" id="swal-input-file" class="swal2-file" multiple accept="image/*,.pdf,.docx" style="display: block; width: 100%; margin-top: 5px;">
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                focusConfirm: false,
                preConfirm: () => {
                    const firstName = document.getElementById('swal-input1').value;
                    const empCode = document.getElementById('swal-input3').value;

                    if (!firstName || !empCode) {
                        Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô');
                        return false;
                    }

                    return {
                        firstName: firstName,
                        lastName: document.getElementById('swal-input2').value,
                        empCode: empCode,
                        phone: document.getElementById('swal-input4').value,
                        dept: document.getElementById('swal-input5').value,
                        purpose: document.getElementById('swal-input6').value,
                        files: document.getElementById('swal-input-file').files
                    }
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    // ‡πÉ‡∏ä‡πâ FormData ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå
                    const formData = new FormData();
                    formData.append('item_id', id);
                    formData.append('first_name', result.value.firstName);
                    formData.append('last_name', result.value.lastName);
                    formData.append('employees_code', result.value.empCode);
                    formData.append('phone_number', result.value.phone);
                    formData.append('affiliation', result.value.dept);
                    formData.append('purpose', result.value.purpose);

                    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô FormData (‡∏ä‡∏∑‡πà‡∏≠ 'files' ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö Backend)
                    if (result.value.files.length > 0) {
                        for (let i = 0; i < result.value.files.length; i++) {
                            formData.append('files', result.value.files[i]);
                        }
                    }

                    // ‡πÅ‡∏™‡∏î‡∏á Loading ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏™‡πà‡∏á
                    Swal.fire({
                        title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...',
                        allowOutsideClick: false,
                        didOpen: () => { Swal.showLoading(); }
                    });

                    fetch(`http://${SERVER_IP}:5000/borrow`, {
                        method: 'POST',
                        body: formData // ‡∏™‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô formData ‡πÅ‡∏ó‡∏ô JSON
                    })
                        .then(res => res.json())
                        .then(data => {
                            if (data.message && !data.error) {
                                Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success')
                                    .then(() => location.reload());
                            } else {
                                Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', data.error || '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', 'error');
                            }
                        })
                        .catch(err => {
                            Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ', 'error');
                        });
                }
            });
        }


        function repairItem(id) {
            // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ global ‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ß‡πâ‡∏ï‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤ (currentItemData)
            // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏≥‡∏°‡∏≤‡πÉ‡∏™‡πà‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
            const item = currentItemData || {};


            Swal.fire({
                title: 'üìã ‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏° / ‡∏û‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå',
                width: '650px',
                html: `
    <div style="text-align: left; font-family: 'Sarabun', sans-serif; color: #333;">
        
        <div style="background: #fdfdfd; padding: 15px; border-radius: 12px; border: 1px solid #e0e0e0; margin-bottom: 20px; box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);">
            <div style="margin-bottom: 12px;">
                <label style="font-weight: bold; font-size: 14px; color: #555;">‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á / ‡∏£‡∏∏‡πà‡∏ô</label>
                <input id="sw-brand" class="swal2-input" style="width: 100%; margin: 5px 0; height: 40px; font-size: 15px;" value="${item.item_name || ''}" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠/‡∏£‡∏∏‡πà‡∏ô">
            </div>

            <div style="display: flex; gap: 10px;">
                <div style="flex: 1;">
                    <label style="font-weight: bold; font-size: 12px; color: #666;">Serial Number</label>
                    <input id="sw-sn" class="swal2-input" style="width: 100%; margin: 5px 0; height: 38px; font-size: 13px; text-align: center;" value="${item.serial_number || ''}" placeholder="S/N">
                </div>
                <div style="flex: 1;">
                    <label style="font-weight: bold; font-size: 12px; color: #666;">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏™‡∏±‡∏ç‡∏ç‡∏≤</label>
                    <input id="sw-ct" class="swal2-input" style="width: 100%; margin: 5px 0; height: 38px; font-size: 13px; text-align: center;" value="${item.contract_number || ''}" placeholder="contract No.">
                </div>
                <div style="flex: 1;">
                    <label style="font-weight: bold; font-size: 12px; color: #666;">‡πÄ‡∏•‡∏Ç‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô</label>
                    <input id="sw-asset" class="swal2-input" style="width: 100%; margin: 5px 0; height: 38px; font-size: 13px; text-align: center;" value="${item.asset_number || ''}" placeholder="Asset No.">
                </div>
            </div>
        </div>

        <div style="padding: 0 5px;">
            <div style="margin-bottom: 12px;">
                <label style="font-weight: bold; font-size: 14px;">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á / ‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á *</label>
                <input id="sw-owner" class="swal2-input" style="width: 100%; margin: 5px 0; height: 40px; font-size: 15px;" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
            </div>

            <div style="display: flex; gap: 15px; margin-bottom: 12px;">
                <div style="flex: 1;">
                    <label style="font-weight: bold; font-size: 14px;">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô *</label>
                    <input id="sw-code" class="swal2-input" style="width: 100%; margin: 5px 0; height: 40px; font-size: 15px;" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô">
                </div>
                <div style="flex: 1;">
                    <label style="font-weight: bold; font-size: 14px;">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                    <input id="sw-phone" class="swal2-input" style="width: 100%; margin: 5px 0; height: 40px; font-size: 15px;" placeholder="08x-xxxxxxx">
                </div>
            </div>

            <div style="margin-bottom: 15px;">
                <label style="font-weight: bold; font-size: 14px;">‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î / ‡πÅ‡∏ú‡∏ô‡∏Å</label>
                <input id="sw-dept" class="swal2-input" style="width: 100%; margin: 5px 0; height: 40px; font-size: 15px;" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÅ‡∏ú‡∏ô‡∏Å">
            </div>

            <div style="margin-bottom: 15px;">
                <label style="font-weight: bold; font-size: 14px; color: #d63384;">‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ä‡∏≥‡∏£‡∏∏‡∏î *</label>
                <textarea id="sw-problem" class="swal2-textarea" style="width: 100%; margin: 5px 0; font-size: 14px; height: 90px; border-radius: 8px;" placeholder="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏ö..."></textarea>
            </div>
            
            <label style="font-weight: bold; font-size: 13px; color: #666;"><i class="fas fa-paperclip"></i> ‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û / ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô</label>
            <input type="file" id="sw-file" class="swal2-file" style="width: 100%; font-size: 13px; margin-top: 5px; border: none;" multiple accept="image/*,.pdf">
        </div>
    </div>
    `,
                showCancelButton: true,
                confirmButtonText: '‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                confirmButtonColor: '#ffc107',
                focusConfirm: false,
                preConfirm: () => {
                    // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å HTML ‡∏Ç‡∏≠‡∏á Swal
                    const data = {
                        brand: document.getElementById('sw-brand').value,
                        serial_number: document.getElementById('sw-sn').value,
                        contract_number: document.getElementById('sw-ct').value,
                        asset_number: document.getElementById('sw-asset').value,
                        employee_name: document.getElementById('sw-owner').value,
                        employees_code: document.getElementById('sw-code').value,
                        phone_number: document.getElementById('sw-phone').value,
                        affiliation: document.getElementById('sw-dept').value,
                        problem: document.getElementById('sw-problem').value,
                        files: document.getElementById('sw-file').files
                    };

                    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô (Validation)
                    if (!data.employee_name || !data.employees_code || !data.problem) {
                        Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠, ‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ‡πÅ‡∏•‡∏∞‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∏‡∏î');
                        return false;
                    }
                    return data;
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const formData = new FormData();

                    // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏•‡∏á‡πÉ‡∏ô FormData
                    Object.keys(result.value).forEach(key => {
                        if (key !== 'files') {
                            formData.append(key, result.value[key]);
                        }
                    });

                    // ‡πÄ‡∏û‡∏¥‡πà‡∏° item_id ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢
                    formData.append('item_id', id);

                    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û/‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ (‡∏Å‡∏£‡∏ì‡∏µ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå)
                    const files = result.value.files;
                    if (files.length > 0) {
                        for (let i = 0; i < files.length; i++) {
                            formData.append('files', files[i]); // ‡∏ä‡∏∑‡πà‡∏≠ 'files' ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö Backend
                        }
                    }

                    // ‡πÅ‡∏™‡∏î‡∏á Loading
                    Swal.fire({
                        title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...',
                        allowOutsideClick: false,
                        didOpen: () => { Swal.showLoading(); }
                    });

                    // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á API
                    fetch(`http://${SERVER_IP}:5000/api/repair`, {
                        method: 'POST',
                        body: formData // ‡∏™‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô FormData (‡∏´‡πâ‡∏≤‡∏°‡∏ï‡∏±‡πâ‡∏á Headers ‡πÄ‡∏õ‡πá‡∏ô JSON)
                    })
                        .then(res => res.json())
                        .then(data => {
                            if (data.success) {
                                Swal.fire({
                                    icon: 'success',
                                    title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                                    text: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
                                    confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
                                }).then(() => location.reload());
                            } else {
                                Swal.fire('‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', data.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', 'error');
                            }
                        })
                        .catch(err => {
                            console.error("Fetch Error:", err);
                            Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ', 'error');
                        });
                }
            });
        }



        function returnItem(id) {
            // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Ñ‡∏∑‡∏ô
            fetch(`http://${SERVER_IP}:5000/borrowing-active`)
                .then(res => res.json())
                .then(logs => {
                    // ‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö item ‡∏ô‡∏µ‡πâ
                    const borrowLog = logs.find(log => log.item_id == id);

                    if (!borrowLog) {
                        Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ', 'error');
                        return;
                    }

                    Swal.fire({
                        title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå',
                        html: `
                            <div style="text-align: left; background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                                <p><strong>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°:</strong></p>
                                <p>‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡∏°: ${borrowLog.first_name} ${borrowLog.last_name}</p>
                                <p>‡∏ß‡∏±‡∏ô‡∏¢‡∏∑‡∏°: ${new Date(borrowLog.borrow_date).toLocaleDateString('th-TH')}</p>
                                <p>Log ID: ${borrowLog.log_id}</p>
                            </div>
                            <p>‡πÇ‡∏õ‡∏£‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</p>
                        `,
                        showCancelButton: true,
                        confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô',
                        cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                        confirmButtonColor: '#0056b3',
                        cancelButtonColor: '#6c757d'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            // ‡πÅ‡∏™‡∏î‡∏á Loading
                            Swal.fire({
                                title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...',
                                allowOutsideClick: false,
                                didOpen: () => { Swal.showLoading(); }
                            });

                            // ‡∏™‡πà‡∏á POST ‡πÑ‡∏õ‡∏ó‡∏µ‡πà /return
                            fetch(`http://${SERVER_IP}:5000/return`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    log_id: borrowLog.log_id,
                                    item_id: id
                                })
                            })
                                .then(res => res.json())
                                .then(data => {
                                    if (data.message) {
                                        Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', '‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success')
                                            .then(() => location.reload());
                                    } else {
                                        Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', data.error || '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', 'error');
                                    }
                                })
                                .catch(err => {
                                    Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ: ' + err.message, 'error');
                                });
                        }
                    });
                })
                .catch(err => {
                    Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡πÑ‡∏î‡πâ: ' + err.message, 'error');
                });
        }
    </script>
</body>

</html>